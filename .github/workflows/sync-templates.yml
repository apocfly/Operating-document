name: Sync Issue Templates
on:
  schedule:
    # æ¯å‘¨ä¸€å‡Œæ™¨0ç‚¹ï¼ˆUTCæ—¶é—´ï¼‰è‡ªåŠ¨åŒæ­¥ï¼Œç›¸å½“äºåŒ—äº¬æ—¶é—´å‘¨ä¸€æ—©ä¸Š8ç‚¹
    - cron: '0 0 * * 1'
  workflow_dispatch:      # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  push:
    branches: [ main ]
    paths:
      - '.github/workflows/sync-templates.yml'  # å½“å·¥ä½œæµæ–‡ä»¶æœ¬èº«æ›´æ–°æ—¶ä¹Ÿè§¦å‘

jobs:
  sync-templates:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # éœ€è¦å†™å…¥æƒé™æ¥æäº¤æ›´æ”¹
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0  # è·å–æ‰€æœ‰å†å²è®°å½•ï¼Œä¾¿äºæ¨é€

    - name: Set up Git
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"

    - name: Sync templates from issue-templates repository
      run: |
        # å…‹éš†æ¨¡æ¿ä»“åº“åˆ°ä¸´æ—¶ç›®å½•
        git clone https://github.com/apocfly/issue-templates temp-templates
        
        # ç¡®ä¿ç›®æ ‡ç›®å½•å­˜åœ¨
        mkdir -p .github/ISSUE_TEMPLATE
        
        # å¤‡ä»½å¯èƒ½å­˜åœ¨çš„è‡ªå®šä¹‰é…ç½®æ–‡ä»¶ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
        if [ -f ".github/ISSUE_TEMPLATE/config.yml" ]; then
          cp .github/ISSUE_TEMPLATE/config.yml config-backup.yml
        fi
        
        # å¤åˆ¶æ‰€æœ‰æ¨¡æ¿æ–‡ä»¶ï¼ˆæ’é™¤å¯èƒ½ä¸éœ€è¦çš„æ–‡ä»¶ï¼‰
        cp -r temp-templates/.github/ISSUE_TEMPLATE/* .github/ISSUE_TEMPLATE/ || true
        
        # å¦‚æœæœ‰å¤‡ä»½çš„é…ç½®æ–‡ä»¶ï¼Œæ¢å¤å®ƒï¼ˆä¿æŒä»“åº“ç‰¹å®šçš„é…ç½®ï¼‰
        if [ -f "config-backup.yml" ]; then
          cp config-backup.yml .github/ISSUE_TEMPLATE/config.yml
          rm config-backup.yml
        fi
        
        # æ¸…ç†ä¸´æ—¶ç›®å½•
        rm -rf temp-templates

    - name: Check for changes
      id: changes
      run: |
        # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶å˜æ›´
        if git diff --quiet; then
          echo "changes=false" >> $GITHUB_OUTPUT
          echo "ğŸ”„ æ²¡æœ‰æ£€æµ‹åˆ°æ¨¡æ¿å˜æ›´"
        else
          echo "changes=true" >> $GITHUB_OUTPUT
          echo "ğŸ“ æ£€æµ‹åˆ°æ¨¡æ¿å˜æ›´"
          git status
          git diff --name-only
        fi

    - name: Commit and push if changes
      if: steps.changes.outputs.changes == 'true'
      run: |
        git add .github/ISSUE_TEMPLATE/
        git commit -m "ğŸ” chore: è‡ªåŠ¨åŒæ­¥æœ€æ–°çš„ issue æ¨¡æ¿ [skip ci]"
        git push origin main
        
        echo "âœ… æ¨¡æ¿åŒæ­¥å®Œæˆå¹¶å·²æäº¤"
        
    - name: No changes
      if: steps.changes.outputs.changes == 'false'
      run: |
        echo "âœ… æ¨¡æ¿å·²æ˜¯æœ€æ–°ç‰ˆæœ¬ï¼Œæ— éœ€æ›´æ–°"